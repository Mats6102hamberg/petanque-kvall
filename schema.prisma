datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RegistrationStatus {
  PENDING
  PAID
  WAITLIST
  CANCELLED
  CONFIRMED
  REFUNDED
}

enum MatchStatus {
  PENDING
  IN_PROGRESS
  REPORTED_LOCKED
  FINALIZED
}

enum PaymentStatus {
  INITIATED
  PAID
  REFUNDED
  FAILED
}

enum ResultStatus {
  DRAFT
  SUBMITTED
  CONFIRMED
  DISPUTED
}

model User {
  id            String              @id @default(cuid())
  email         String              @unique
  name          String?
  createdAt     DateTime            @default(now())
  player        PlayerProfile?
  registrations Registration[]
  payments      Payment[]
  results       ResultConfirmation[]
  standings     Standing[]
  member1Teams  Team[]              @relation("M1")
  member2Teams  Team[]              @relation("M2")
}

model PlayerProfile {
  id       String @id @default(cuid())
  userId   String @unique
  nickname String?
  elo      Int    @default(1500)
  user     User   @relation(fields: [userId], references: [id])
}

model Venue {
  id      String @id @default(cuid())
  name    String
  address String?
  lanes   Int
  ownerId String?
}

model Event {
  id            String            @id @default(cuid())
  title         String
  date          DateTime
  durationMin   Int
  maxPlayers    Int
  feeSek        Int
  venueId       String?
  status        String            @default("SCHEDULED")
  cutoffAt      DateTime
  createdById   String
  cost          EventCost?
  registrations Registration[]
  rounds        Round[]
  payouts       Payout[]
}

model EventCost {
  id          String @id @default(cuid())
  eventId     String @unique
  laneRentSek Int
  adminFeeSek Int
  reserveSek  Int
  event       Event  @relation(fields: [eventId], references: [id])
}

model Registration {
  id         String             @id @default(cuid())
  eventId    String
  userId     String
  status     RegistrationStatus @default(PENDING)
  paidAmount Int                @default(0)
  createdAt  DateTime           @default(now())
  event      Event              @relation(fields: [eventId], references: [id])
  user       User               @relation(fields: [userId], references: [id])
  payment    Payment?
  checkInAt  DateTime?
}

model Payment {
  id             String        @id @default(cuid())
  registrationId String        @unique
  provider       String
  status         PaymentStatus @default(INITIATED)
  amount         Int
  swishRef       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  registration   Registration  @relation(fields: [registrationId], references: [id])
}

model Round {
  id      String @id @default(cuid())
  eventId String
  index   Int
  matches Match[]
  event   Event  @relation(fields: [eventId], references: [id])
}

model Match {
  id            String     @id @default(cuid())
  roundId       String
  lane          Int
  status        MatchStatus @default(PENDING)
  teamAId       String
  teamBId       String
  scoreA        Int?
  scoreB        Int?
  round         Round      @relation(fields: [roundId], references: [id])
  teamA         Team       @relation("A", fields: [teamAId], references: [id])
  teamB         Team       @relation("B", fields: [teamBId], references: [id])
  confirmations ResultConfirmation[]
}

model Team {
  id        String @id @default(cuid())
  name      String @unique
  member1Id String
  member2Id String
  member1   User   @relation("M1", fields: [member1Id], references: [id])
  member2   User   @relation("M2", fields: [member2Id], references: [id])

  @@unique([member1Id, member2Id])
}

model ResultConfirmation {
  id        String       @id @default(cuid())
  matchId   String
  userId    String
  scoreA    Int
  scoreB    Int
  status    ResultStatus @default(DRAFT)
  createdAt DateTime     @default(now())
  match     Match        @relation(fields: [matchId], references: [id])
  user      User         @relation(fields: [userId], references: [id])
}

model Standing {
  id      String @id @default(cuid())
  eventId String
  userId  String
  wins    Int    @default(0)
  points  Int    @default(0)
  sos     Int    @default(0)
  event   Event  @relation(fields: [eventId], references: [id])
  user    User   @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
}

model Payout {
  id        String   @id @default(cuid())
  eventId   String
  place     Int
  amountSek Int
  userId    String?
  paidOutAt DateTime?
  event     Event    @relation(fields: [eventId], references: [id])
}
